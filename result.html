<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>결과 - 별바람 이름 테스트</title>
  <meta name="description" content="나의 성향으로 탄생한 영혼의 이름과 캐릭터를 확인해보세요!" />
  <link rel="icon" type="image/png" sizes="512x512" href="favicon-512.png" />
  <style>
    :root { --ink:#1f2937; --muted:#6b7280; --brand:#ef6b8c; --card:#fffaf0; --line:#ffe4b5; }
    html,body{margin:0;padding:0;background:#fefcf8;color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
    .container{max-width:1024px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px}
    header.container{padding:20px 16px}
    h1{margin:0 0 6px;font-size:22px}
    .subtle{color:var(--muted);margin:0 0 14px;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    canvas{max-width:100%;border-radius:12px;background:#fff}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--brand);color:#fff;box-shadow:0 6px 14px rgba(239,107,140,.25)}
    .btn.ghost{background:#f3f4f6}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .tags span{background:#f3f4f6;border-radius:999px;padding:6px 10px;font-size:12px;color:#374151}
    .quote-card{border-radius:16px;padding:18px 20px;background:var(--card);border:1px solid var(--line);box-shadow:0 6px 18px rgba(0,0,0,.06);margin-top:14px}
    .quote-card small{color:#9CA3AF;letter-spacing:.3px}
    .quote-text{font-size:18px;line-height:1.5;font-weight:600;color:#374151;margin:10px 0}
    .quote-footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .ad-placeholder{text-align:center;color:#9CA3AF;padding:12px 0;border:1px dashed #e5e7eb;border-radius:10px;margin-top:12px}
    .tip{font-size:12px;color:#9CA3AF;margin-top:8px}
    .err{position:fixed;left:8px;right:8px;bottom:8px;background:#fff3cd;color:#111;border:1px solid #ffecb5;border-radius:10px;padding:10px;font-size:12px;z-index:9999}
  </style>
</head>
<body>
  <header class="container">
    <h1>당신의 결과</h1>
    <p class="subtle">성향 분석을 바탕으로 탄생한 영혼의 이름과 캐릭터</p>
  </header>

  <main class="container card">
    <div class="grid">
      <div>
        <canvas id="charCanvas" width="900" height="900"></canvas>
        <div class="btn-row">
          <button class="btn primary" id="saveFull">결과 저장하기</button>
          <button class="btn ghost" id="ctaInvite">친구도 시켜보기</button>
        </div>
        <div class="tip">* 저장한 이미지는 인스타/카톡 스토리에 최적화되어요.</div>
      </div>

      <div>
        <h2 id="nameText">이름 로딩중…</h2>
        <p id="blurb">성향을 분석 중…</p>
        <div id="tags" class="tags"></div>
        <section id="wisdom" class="quote-card"></section>
        <div class="ad-placeholder">여기에 광고가 표시됩니다</div>
      </div>
    </div>
  </main>

  <section class="container card" style="margin-top:18px;">
    <div class="ad-placeholder">여기에 광고가 표시됩니다</div>
  </section>

  <footer class="container" style="padding:12px 16px 28px;color:#9CA3AF">
    <a href="index.html">다시 테스트하기</a> · <a href="privacy.html">개인정보처리방침</a> · <a href="terms.html">이용약관</a>
  </footer>

  <!-- (있으면 사용) 외부 리소스 -->
  <script src="data/name_parts.js"></script>
  <script src="data/character_layers.js"></script>

  <!-- 안전장치/유틸 & 기본 데이터 -->
  <script>
    // 오류 박스(개발용)
    window.onerror = function(msg, src, line, col){
      const box = document.createElement('div');
      box.className = 'err';
      box.innerHTML = '<b>오류 감지</b><br>'+ msg + '<br><small>'+ (src||'inline') +':'+ (line||0) +':'+ (col||0) +'</small>';
      document.body.appendChild(box);
    };

    // 결과 payload
    function getPayload(){ try{const p=JSON.parse(localStorage.getItem('resultPayload')||'null');return p&&typeof p==='object'?p:null;}catch(e){return null;} }

    // SHIMs (외부 없을 때도 동작)
    window.NAME_PARTS = window.NAME_PARTS || {
      adjectives:["불꽃같은","고요한","자유로운","빛나는","은은한","맑은","빠른","단단한","따스한","깊은"],
      nouns:["매","사슴","늑대","곰","여우","강","바람","별빛","해오라기","자작나무"],
      suffixes:["의 노래","의 그림자","의 숨결","의 빛","의 약속","의 균형","의 숨소리","의 포옹","의 꿈","의 길"]
    };
    window.CHARACTER_LAYERS = window.CHARACTER_LAYERS || {
      rarityWeights:{UR:0.05, SR:0.15, R:0.30, C:0.50},
      layers:[
        {name:"bg",mode:"single",items:[
          {id:"bg-C", rarity:"C",  img:"assets/char/bg/bg_common.png", tags:["any"]},
          {id:"bg-R", rarity:"R",  img:"assets/char/bg/bg_rare.png",   tags:["any"]},
          {id:"bg-SR",rarity:"SR", img:"assets/char/bg/bg_sr.png",     tags:["any"]},
          {id:"bg-UR",rarity:"UR", img:"assets/char/bg/bg_ur.png",     tags:["any"]}
        ]},
        {name:"base",mode:"single",items:[{id:"base-1",img:"assets/char/layer_body.png",tags:["any"]}]},
        {name:"eyes",mode:"single",items:[
          {id:"eyes-happy",img:"assets/char/layer_eyes.png",tags:["wind","earth","star","any"]},
          {id:"eyes-smile",img:"assets/char/layer_eyes.png",tags:["fire","water","any"]}
        ]},
        {name:"mouth",mode:"single",items:[
          {id:"mouth-smile",img:"assets/char/layer_mouth.png",tags:["wind","earth","star","any"]},
          {id:"mouth-u",    img:"assets/char/layer_mouth.png",tags:["fire","water","any"]}
        ]},
        {name:"accessory",mode:"optional",chance:0.85,items:[
          {id:"acc-feather",img:"assets/char/layer_decor.png",tags:["wind","star","any"]},
          {id:"acc-flame",  img:"assets/char/layer_decor.png",tags:["fire","any"]},
          {id:"acc-leaf",   img:"assets/char/layer_decor.png",tags:["earth","any"]},
          {id:"acc-drop",   img:"assets/char/layer_decor.png",tags:["water","any"]}
        ]},
        {name:"border",mode:"optional",chance:1.0,items:[
          {id:"border-C", rarity:"C",  img:"assets/char/border/border_common.png",tags:["any"]},
          {id:"border-R", rarity:"R",  img:"assets/char/border/border_rare.png",  tags:["any"]},
          {id:"border-SR",rarity:"SR", img:"assets/char/border/border_sr.png",    tags:["any"]},
          {id:"border-UR",rarity:"UR", img:"assets/char/border/border_ur.png",    tags:["any"]}
        ]}
      ]
    };

    // 성향→테마
    function pickThemeByAxes(axes){
      const arr = [
        {theme:'wind',  v:(axes?.free||0)+0.3*(axes?.dreamy||0)},
        {theme:'fire',  v:(axes?.lively||0)+0.2*(axes?.extra||0)},
        {theme:'earth', v:(axes?.warm||0)+0.2*(1-(axes?.free||0))},
        {theme:'water', v:(1-(axes?.extra||0))},
        {theme:'star',  v:(axes?.dreamy||0)+0.2*(axes?.free||0)}
      ].sort((a,b)=>b.v-a.v);
      return arr[0].theme;
    }
    // 희귀도
    function pickRarity(weights){
      const w = weights || {UR:0.05, SR:0.15, R:0.30, C:0.50};
      const r = Math.random(); let acc=0;
      for(const k of ["UR","SR","R","C"]){ acc+=w[k]||0; if(r<=acc) return k; }
      return "C";
    }
    // 아이템 선택
    function pickItem(layer, theme, rarity){
      const items = layer.items||[];
      let pool = items.filter(it => it.rarity===rarity && ((it.tags||[]).includes(theme)|| (it.tags||[]).includes("any")));
      if (!pool.length) pool = items.filter(it => (it.tags||[]).includes(theme) || (it.tags||[]).includes("any"));
      if (!pool.length) pool = items;
      if (!pool.length) return null;
      return pool[Math.floor(Math.random()*pool.length)];
    }
  </script>

  <!-- 이름/명언/포스터/버튼 -->
  <script>
    function genNameAndMeta(){
      const p = getPayload();
      const a = window.NAME_PARTS;
      const adj = a.adjectives[Math.floor(Math.random()*a.adjectives.length)];
      const noun = a.nouns[Math.floor(Math.random()*a.nouns.length)];
      const suf = a.suffixes[Math.floor(Math.random()*a.suffixes.length)];
      const name = `${adj} ${noun}${suf}`;
      const nameEl = document.getElementById('nameText');
      if (nameEl && (!nameEl.textContent || /로딩/i.test(nameEl.textContent))) nameEl.textContent = name;
      const blurb = document.getElementById('blurb');
      if (blurb) {
        blurb.textContent = p?.axes ? '당신의 성향 데이터를 반영해 이름을 만들었어요.' : '임시 조합으로 이름을 만들었어요.';
      }
      const tags = document.getElementById('tags');
      if (tags && p?.axes) {
        tags.innerHTML = `<span>free:${(p.axes.free*100|0)}%</span><span>extra:${(p.axes.extra*100|0)}%</span>
          <span>lively:${(p.axes.lively*100|0)}%</span><span>warm:${(p.axes.warm*100|0)}%</span>
          <span>dreamy:${(p.axes.dreamy*100|0)}%</span>`;
      }
    }

    // 텍스트 줄바꿈
    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split(' '); let line=''; const lines=[];
      for (let n=0; n<words.length; n++) {
        const test = line + (line?' ':'') + words[n];
        if (ctx.measureText(test).width > maxWidth && n>0){ lines.push(line); line = words[n]; }
        else line = test;
      }
      lines.push(line);
      lines.forEach((ln,i)=>ctx.fillText(ln,x,y+i*lineHeight));
      return y + lines.length*lineHeight;
    }

    // 모바일 전체 포스터(1080x1920)
    function drawFullPoster(W,H){
      const srcCanvas = document.getElementById('charCanvas');
      const name = (document.getElementById('nameText')?.textContent || '나의 영혼의 이름').trim();
      const quoteEl = document.getElementById('wisdom');
      const raw = quoteEl?.textContent || '';
      const quoteMatch = raw.match(/“([^”]+)”/);
      const quote = quoteMatch ? quoteMatch[1] : raw.replace(/\s+/g,' ').slice(0,120);
      const siteTitle = '별바람 이름 테스트';
      const siteUrl = 'yogitobi31.github.io';

      const c = document.createElement('canvas'); c.width=W; c.height=H;
      const ctx = c.getContext('2d');

      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0,'#fff8e1'); g.addColorStop(1,'#fdebd2');
      ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

      ctx.fillStyle='#ef6b8c'; ctx.textAlign='center';
      ctx.font=`bold ${Math.round(W*0.054)}px system-ui,Arial`;
      ctx.fillText(siteTitle, W/2, Math.round(H*0.075));

      const box = Math.min(W*0.78, H*0.50);
      const x = (W-box)/2, y = Math.round(H*0.11);
      ctx.save();
      const r = Math.round(box*0.04);
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+box,y,x+box,y+box,r);
      ctx.arcTo(x+box,y+box,x,y+box,r);
      ctx.arcTo(x,y+box,x,y,r);
      ctx.arcTo(x,y,x+box,y,r);
      ctx.closePath(); ctx.clip();
      ctx.drawImage(srcCanvas,0,0,srcCanvas.width,srcCanvas.height,x,y,box,box);
      ctx.restore();

      ctx.fillStyle='#1f2937'; ctx.textAlign='center';
      ctx.font=`800 ${Math.round(W*0.06)}px system-ui,Arial`;
      ctx.fillText(name, W/2, y+box+Math.round(H*0.09), W*0.9);

      ctx.fillStyle='#6b7280';
      ctx.font=`500 ${Math.round(W*0.036)}px system-ui,Arial`;
      ctx.fillText('나의 성향으로 만든 이름 & 캐릭터', W/2, y+box+Math.round(H*0.14));

      const cardW=Math.round(W*0.84), cardH=Math.round(H*0.20);
      const cardX=(W-cardW)/2, cardY=y+box+Math.round(H*0.16);
      ctx.fillStyle='#fffaf0'; ctx.strokeStyle='#ffe4b5'; ctx.lineWidth=4;
      ctx.beginPath(); const cr=24;
      ctx.moveTo(cardX+cr,cardY);
      ctx.arcTo(cardX+cardW,cardY,cardX+cardW,cardY+cardH,cr);
      ctx.arcTo(cardX+cardW,cardY+cardH,cardX,cardY+cardH,cr);
      ctx.arcTo(cardX,cardY+cardH,cardX,cardY,cr);
      ctx.arcTo(cardX,cardY,cardX+cardW,cardY,cr);
      ctx.closePath(); ctx.fill(); ctx.stroke();

      ctx.fillStyle='#374151'; ctx.textAlign='left';
      const innerX=cardX+24, innerY=cardY+32, innerW=cardW-48;
      ctx.font=`700 ${Math.round(W*0.04)}px system-ui,Arial`;
      wrapText(ctx, `“${quote}”`, innerX, innerY, innerW, Math.round(W*0.055));

      ctx.textAlign='center'; ctx.fillStyle='#ef6b8c';
      ctx.font=`700 ${Math.round(W*0.038)}px system-ui,Arial`;
      ctx.fillText(siteUrl, W/2, H - Math.round(H*0.05));

      return c;
    }

    // 버튼 동작: 저장/초대(첫 화면 링크 공유/복사)
    async function initButtons(){
      document.getElementById('saveFull')?.addEventListener('click', ()=>{
        const poster = drawFullPoster(1080,1920);
        const a = document.createElement('a');
        a.download = '별바람_결과.png';
        a.href = poster.toDataURL('image/png');
        a.click();
      });

      document.getElementById('ctaInvite')?.addEventListener('click', async ()=>{
        // 첫 화면(랜딩) URL만 고정으로 공유/복사
        const landingUrl = 'https://yogitobi31.github.io/'; // 필요하면 프로젝트 페이지에 맞춰 변경
        try {
          if (navigator.share) {
            await navigator.share({ title: '별바람 이름 테스트', text: '나도 해봤더니 재밌어!', url: landingUrl });
            return;
          }
        } catch(_) { /* fallback */ }
        try {
          await navigator.clipboard.writeText(landingUrl);
          alert('링크가 복사되었습니다!');
        } catch(e){
          const ta=document.createElement('textarea'); ta.value=landingUrl;
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
          alert('링크가 복사되었습니다!');
        }
      });
    }
  </script>

  <!-- 캐릭터 렌더(테마+희귀도) & 명언 -->
  <script>
    function renderByRarityTheme(){
      const cfg = window.CHARACTER_LAYERS;
      const canvas = document.getElementById('charCanvas');
      if (!cfg?.layers?.length || !canvas) return;
      const ctx = canvas.getContext('2d');

      let axes=null; try{ axes=getPayload()?.axes||null; }catch(e){}
      const theme = axes ? pickThemeByAxes(axes) : 'star';
      const rarity = pickRarity(cfg.rarityWeights);

      const picks = (cfg.layers||[]).map(layer=>{
        if (layer.mode==='optional'){
          const chance = (typeof layer.chance==='number') ? layer.chance : 0.6;
          if (Math.random() > chance) return null;
        }
        const item = pickItem(layer, theme, rarity);
        return item ? (item.img||item.src) : null;
      }).filter(Boolean);

      const imgs=[]; let loaded=0;
      function finish(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#fff8e1'; ctx.fillRect(0,0,canvas.width,canvas.height);
        imgs.forEach(img=>img && ctx.drawImage(img,0,0,canvas.width,canvas.height));
        const nameEl=document.getElementById('nameText');
        if (nameEl && !/\[(UR|SR|R|C)\]/.test(nameEl.textContent)) nameEl.textContent += ` [${rarity}]`;
      }
      picks.forEach((url,i)=>{
        const img=new Image();
        img.onload=()=>{imgs[i]=img; if(++loaded===picks.length) finish();};
        img.onerror=()=>{if(++loaded===picks.length) finish();};
        img.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
      });
    }

    function renderQuote(){
      const QUOTES = {
        earth: [{leader:"Red Cloud (Oglala Lakota)",nation:"Oglala Lakota",
          quote:"We do not want riches; we want our children trained and brought up properly.",
          ko:"우리는 부를 원하지 않습니다. 우리 아이들이 제대로 배우고 자라길 원합니다.",
          source:"Address at Cooper Union (1870)",url:"https://teachingamericanhistory.org/document/address-at-cooper-union-2/"}],
        water: [{leader:"Chief Joseph (Nez Perce)",nation:"Nez Perce",
          quote:"From where the sun now stands, I will fight no more forever.",
          ko:"지금 이 자리에서, 나는 더 이상 싸우지 않겠습니다.",
          source:"Surrender Statement (1877)",url:"https://teachingamericanhistory.org/document/i-will-fight-no-more-forever/"}],
        star: [{leader:"Sitting Bull (Hunkpapa Lakota)",nation:"Hunkpapa Lakota",
          quote:"Let us put our minds together and see what life we can make for our children.",
          ko:"우리 마음을 모아, 아이들을 위해 어떤 삶을 만들지 생각해 봅시다.",
          source:"Library of Congress",url:"https://www.loc.gov/pictures/item/2016648134/"}],
        wind: [{leader:"Luther Standing Bear (Oglala Lakota)",nation:"Oglala Lakota",
          quote:"The old Lakota was wise. He knew that man's heart, away from nature, becomes hard.",
          ko:"현명한 라코타는 알았어요. 자연과 멀어질수록 사람의 마음은 굳어진다는 것을.",
          source:"Land of the Spotted Eagle (1933)",url:"https://en.wikipedia.org/wiki/Luther_Standing_Bear"}],
        fire: [{leader:"Sarah Winnemucca (Northern Paiute)",nation:"Northern Paiute",
          quote:"I have nothing to say for myself, only for my people.",
          ko:"나 자신을 위한 말은 없습니다. 오직 내 사람들을 위한 말만 있습니다.",
          source:"Life Among the Piutes (1883)",url:"https://archive.org/details/lifeamongpiutesh00sara"}]
      };
      let axes=null; try{ axes=getPayload()?.axes||null; }catch(e){}
      const theme = axes ? pickThemeByAxes(axes) : 'star';
      const pool = QUOTES[theme] || QUOTES.star;
      const q = pool[Math.floor(Math.random()*pool.length)];
      const el = document.getElementById('wisdom');
      el.innerHTML = `
        <small>전통의 말 · ${q.nation}</small>
        <div class="quote-text">“${q.quote}”</div>
        ${q.ko ? `<div style="font-size:13px;color:#6b7280;margin-top:6px;">${q.ko}</div>` : ``}
        <div class="quote-footer" style="margin-top:8px;">
          <div>— ${q.leader}</div>
          <a href="${q.url}" target="_blank" rel="noopener">출처: ${q.source}</a>
        </div>`;
    }

    document.addEventListener('DOMContentLoaded', function(){
      genNameAndMeta();        // 1) 이름/텍스트
      renderByRarityTheme();   // 2) 캐릭터 합성
      renderQuote();           // 3) 명언 카드
      initButtons();           // 4) 저장/초대(첫 화면 공유)
    });
  </script>
</body>
</html>
